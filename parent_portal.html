<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin Tigers - Parent Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-red': '#ce0707',
                        'brand-blue': '#013378',
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #013378;
            padding: 24px;
            overflow-y: auto;
        }

        .main-content {
            margin-left: 280px;
            padding: 32px;
            min-height: 100vh;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 8px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: #ce0707;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn-primary {
            background: #ce0707;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #b80606;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-unpaid {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Belt Visual Styles */
        .belt-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 16px 0;
        }

        .belt-segment {
            width: 60px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            border: 2px solid #e5e7eb;
            position: relative;
        }

        .belt-segment.current {
            border-color: #ce0707;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(206, 7, 7, 0.1);
        }

        .belt-segment.completed {
            opacity: 1;
        }

        .belt-segment.upcoming {
            opacity: 0.3;
        }

        .belt-white { background: #ffffff; color: #111827; }
        .belt-white-stripe { background: linear-gradient(90deg, #ffffff 80%, #374151 80%); color: #111827; }
        .belt-yellow { background: #fde047; color: #111827; }
        .belt-yellow-stripe { background: linear-gradient(90deg, #fde047 80%, #374151 80%); color: #111827; }
        .belt-orange { background: #fb923c; color: #111827; }
        .belt-orange-stripe { background: linear-gradient(90deg, #fb923c 80%, #374151 80%); color: #111827; }
        .belt-green { background: #4ade80; color: #111827; }
        .belt-green-stripe { background: linear-gradient(90deg, #4ade80 80%, #374151 80%); color: #111827; }
        .belt-blue { background: #60a5fa; color: white; }
        .belt-blue-stripe { background: linear-gradient(90deg, #60a5fa 80%, #374151 80%); color: white; }
        .belt-purple { background: #c084fc; color: white; }
        .belt-purple-stripe { background: linear-gradient(90deg, #c084fc 80%, #374151 80%); color: white; }
        .belt-brown { background: #a16207; color: white; }
        .belt-brown-stripe { background: linear-gradient(90deg, #a16207 80%, #374151 80%); color: white; }
        .belt-red { background: #f87171; color: white; }
        .belt-red-stripe { background: linear-gradient(90deg, #f87171 80%, #374151 80%); color: white; }
        .belt-black { background: #1f2937; color: white; }

        /* Store Product Card */
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .product-card:hover {
            border-color: #013378;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f3f4f6;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Logo -->
        <div style="text-align: center; margin-bottom: 32px;">
            <img src="https://app.twintigerst–∞ekwondo.com/logo.png" alt="Twin Tigers Logo" style="width: 100px; height: 100px; margin: 0 auto 12px; border-radius: 12px; object-fit: contain;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 200%22%3E%3Ccircle cx=%22100%22 cy=%22100%22 r=%2290%22 fill=%22%23ffffff%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23013378%22 font-size=%2260%22 font-family=%22Arial%22 font-weight=%22bold%22%3ETT%3C/text%3E%3C/svg%3E'">
            <h2 style="color: white; font-weight: 700; font-size: 20px; margin-bottom: 4px;" id="studio-name">Twin Tigers Taekwondo</h2>
            <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Parent Portal</p>
        </div>

        <!-- Welcome -->
        <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
            <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin-bottom: 4px;">Welcome back,</p>
            <p style="color: white; font-weight: 600; font-size: 16px;" id="parent-name">Loading...</p>
        </div>

        <!-- Navigation -->
        <nav>
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" onclick="switchTab('students')">
                <span>üë•</span> Students
            </div>
            <div class="nav-item" onclick="switchTab('classes')">
                <span>üìÖ</span> Classes
            </div>
            <div class="nav-item" onclick="switchTab('store')">
                <span>üõçÔ∏è</span> Store
            </div>
            <div class="nav-item" onclick="switchTab('announcements')">
                <span>üì¢</span> Announcements
            </div>
            <div class="nav-item" onclick="switchTab('billing')">
                <span>üí≥</span> Billing
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <span>‚öôÔ∏è</span> Settings
            </div>
            <div class="nav-item" onclick="handleLogout()" style="margin-top: 24px; background: rgba(255,255,255,0.1);">
                <span>üö™</span> Logout
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">Dashboard</h1>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;" id="dashboard-cards">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">My Students</h1>
            <div id="students-list">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Classes Tab -->
        <div id="classes" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">Available Classes</h1>
            <div id="classes-list">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Store Tab (NEW) -->
        <div id="store" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">Studio Store</h1>
            <p style="color: #6b7280; margin-bottom: 24px;">Order gear and merchandise for pickup at the studio</p>
            
            <!-- Orders Section -->
            <div class="card" style="margin-bottom: 32px;">
                <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Your Orders</h2>
                <div id="order-history">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">No orders yet</p>
                </div>
            </div>

            <!-- Products Grid -->
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Available Products</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;" id="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Announcements Tab -->
        <div id="announcements" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">Announcements</h1>
            <div id="announcements-list">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Billing Tab -->
        <div id="billing" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">Billing & Membership</h1>
            
            <!-- Current Plan -->
            <div class="card">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Current Plan</h2>
                <div id="billing-info">
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Payment History -->
            <div class="card">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Payment History</h2>
                <div id="payment-history">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">No payment history yet</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px;">Settings</h1>
            
            <div class="card">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Profile Information</h2>
                <form id="profile-form">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px;">First Name</label>
                        <input type="text" id="profile-first-name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px;">Last Name</label>
                        <input type="text" id="profile-last-name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px;">Phone</label>
                        <input type="tel" id="profile-phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px;">Emergency Contact</label>
                        <input type="text" id="profile-emergency" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>

                    <button type="submit" class="btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://ipvutcoacitpcaeynexr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwdnV0Y29hY2l0cGNhZXluZXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NDMyMjcsImV4cCI6MjA0ODQxOTIyN30.3Afy_jjfTrhhhuVAkEBHBBBviFnGW0jI8WTYQZLxEDc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global data
        let currentParent = null;
        let currentStudents = [];
        let currentClasses = [];

        // Belt progression order
        const BELT_PROGRESSION = [
            { name: 'White Belt', class: 'belt-white', nextTest: 'White Belt + Stripe' },
            { name: 'White Belt + Stripe', class: 'belt-white-stripe', nextTest: 'Yellow Belt' },
            { name: 'Yellow Belt', class: 'belt-yellow', nextTest: 'Yellow Belt + Stripe' },
            { name: 'Yellow Belt + Stripe', class: 'belt-yellow-stripe', nextTest: 'Orange Belt' },
            { name: 'Orange Belt', class: 'belt-orange', nextTest: 'Orange Belt + Stripe' },
            { name: 'Orange Belt + Stripe', class: 'belt-orange-stripe', nextTest: 'Green Belt' },
            { name: 'Green Belt', class: 'belt-green', nextTest: 'Green Belt + Stripe' },
            { name: 'Green Belt + Stripe', class: 'belt-green-stripe', nextTest: 'Blue Belt' },
            { name: 'Blue Belt', class: 'belt-blue', nextTest: 'Blue Belt + Stripe' },
            { name: 'Blue Belt + Stripe', class: 'belt-blue-stripe', nextTest: 'Purple Belt' },
            { name: 'Purple Belt', class: 'belt-purple', nextTest: 'Purple Belt + Stripe' },
            { name: 'Purple Belt + Stripe', class: 'belt-purple-stripe', nextTest: 'Brown Belt' },
            { name: 'Brown Belt', class: 'belt-brown', nextTest: 'Brown Belt + Stripe' },
            { name: 'Brown Belt + Stripe', class: 'belt-brown-stripe', nextTest: 'Red Belt' },
            { name: 'Red Belt', class: 'belt-red', nextTest: 'Red Belt + Stripe' },
            { name: 'Red Belt + Stripe', class: 'belt-red-stripe', nextTest: 'Black Belt' },
            { name: 'Black Belt', class: 'belt-black', nextTest: null }
        ];

        // Belt test pricing (you can adjust these)
        const BELT_TEST_PRICES = {
            'White Belt + Stripe': 30,
            'Yellow Belt': 40,
            'Yellow Belt + Stripe': 30,
            'Orange Belt': 40,
            'Orange Belt + Stripe': 30,
            'Green Belt': 50,
            'Green Belt + Stripe': 30,
            'Blue Belt': 50,
            'Blue Belt + Stripe': 30,
            'Purple Belt': 60,
            'Purple Belt + Stripe': 30,
            'Brown Belt': 60,
            'Brown Belt + Stripe': 30,
            'Red Belt': 70,
            'Red Belt + Stripe': 30,
            'Black Belt': 100
        };

        // Store products (hardcoded for now)
        const STORE_PRODUCTS = [
            {
                id: 'uniform-basic',
                name: 'Basic Uniform Set',
                price: 45,
                image: 'https://via.placeholder.com/300x300?text=Uniform',
                description: 'White uniform with belt',
                checkoutUrl: 'https://square.link/u/UNIFORM_LINK' // Replace with actual Square link
            },
            {
                id: 'tshirt',
                name: 'Twin Tigers T-Shirt',
                price: 20,
                image: 'https://via.placeholder.com/300x300?text=T-Shirt',
                description: 'Official studio t-shirt',
                checkoutUrl: 'https://square.link/u/TSHIRT_LINK'
            },
            {
                id: 'backpack',
                name: 'Training Backpack',
                price: 35,
                image: 'https://via.placeholder.com/300x300?text=Backpack',
                description: 'Durable training backpack',
                checkoutUrl: 'https://square.link/u/BACKPACK_LINK'
            }
        ];

        // Check auth
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            // Load parent data
            await loadParentData(session.user.email);
        }

        // Load parent data from Sheets
        async function loadParentData(email) {
            try {
                // Fetch parent from Sheets
                const response = await fetch(`https://sheetdb.io/api/v1/7gridxho6ejta?sheet=Parents&Email=${email}`);
                const parents = await response.json();
                
                if (parents && parents.length > 0) {
                    currentParent = parents[0];
                    
                    // Update UI
                    document.getElementById('parent-name').textContent = `${currentParent.First_Name} ${currentParent.Last_Name}`;
                    
                    // Load students
                    await loadStudents(currentParent.Parent_Id);
                    
                    // Load other data
                    await loadClasses();
                    await loadAnnouncements();
                    
                    // Populate UI
                    populateDashboard();
                    populateBilling();
                    populateProfile();
                    populateStore();
                }
            } catch (error) {
                console.error('Error loading parent data:', error);
            }
        }

        // Load students
        async function loadStudents(parentId) {
            try {
                const response = await fetch(`https://sheetdb.io/api/v1/7gridxho6ejta?sheet=Students&Parent_Id=${parentId}`);
                const students = await response.json();
                currentStudents = students || [];
                populateStudents();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load classes
        async function loadClasses() {
            try {
                const response = await fetch('https://sheetdb.io/api/v1/7gridxho6ejta?sheet=Classes');
                const classes = await response.json();
                currentClasses = classes || [];
                populateClasses();
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Load announcements
        async function loadAnnouncements() {
            try {
                const response = await fetch('https://sheetdb.io/api/v1/7gridxho6ejta?sheet=Announcements');
                const announcements = await response.json();
                populateAnnouncements(announcements || []);
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        // Populate dashboard
        function populateDashboard() {
            const container = document.getElementById('dashboard-cards');
            
            const html = `
                <div class="card">
                    <h3 style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Students</h3>
                    <p style="font-size: 32px; font-weight: 700; color: #013378;">${currentStudents.length}</p>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Membership</h3>
                    <p style="font-size: 24px; font-weight: 600; color: #013378;">${currentParent?.Membership_Plan || 'N/A'}</p>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Status</h3>
                    <span class="badge ${currentParent?.Membership_Status === 'paid' ? 'badge-paid' : 'badge-unpaid'}">
                        ${currentParent?.Membership_Status === 'paid' ? 'Paid' : 'Unpaid'}
                    </span>
                </div>
                
                <div class="card">
                    <h3 style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">Available Classes</h3>
                    <p style="font-size: 32px; font-weight: 700; color: #013378;">${currentClasses.length}</p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Populate students
        function populateStudents() {
            const container = document.getElementById('students-list');
            
            if (currentStudents.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #6b7280;">No students found</p></div>';
                return;
            }

            let html = '';
            
            currentStudents.forEach(student => {
                const currentBeltIndex = BELT_PROGRESSION.findIndex(b => b.name === student.Belt_Rank);
                const nextBelt = BELT_PROGRESSION[currentBeltIndex]?.nextTest;
                const testPrice = nextBelt ? BELT_TEST_PRICES[nextBelt] : null;

                html += `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;">${student.First_Name} ${student.Last_Name}</h3>
                                <p style="color: #6b7280; font-size: 14px;">Age ${student.Age} ‚Ä¢ ${student.Status}</p>
                            </div>
                            <span class="badge" style="background: #e0f2fe; color: #075985;">${student.Belt_Rank}</span>
                        </div>

                        <!-- Belt Progression Visual -->
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Belt Progress</p>
                            <div class="belt-container">
                                ${BELT_PROGRESSION.map((belt, index) => {
                                    let status = 'upcoming';
                                    if (index < currentBeltIndex) status = 'completed';
                                    if (index === currentBeltIndex) status = 'current';
                                    
                                    return `<div class="belt-segment ${belt.class} ${status}" title="${belt.name}"></div>`;
                                }).join('')}
                            </div>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                Current: ${student.Belt_Rank}${nextBelt ? ` ‚Üí Next: ${nextBelt}` : ' (Maximum rank achieved!)'}
                            </p>
                        </div>

                        ${nextBelt && testPrice ? `
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <p style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Ready for Next Belt Test</p>
                                <p style="font-size: 12px; color: #92400e; margin-bottom: 8px;">${nextBelt} - $${testPrice}</p>
                                <button class="btn-primary" onclick="payForBeltTest('${student.Student_Id}', '${nextBelt}', ${testPrice})">
                                    Pay for Belt Test
                                </button>
                            </div>
                        ` : ''}

                        ${student.Medical_Conditions ? `
                            <div style="margin-top: 12px; padding: 12px; background: #fef2f2; border-radius: 8px;">
                                <p style="font-size: 12px; font-weight: 600; color: #991b1b; margin-bottom: 4px;">Medical Note:</p>
                                <p style="font-size: 12px; color: #991b1b;">${student.Medical_Conditions}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Populate classes
        function populateClasses() {
            const container = document.getElementById('classes-list');
            
            if (currentClasses.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #6b7280;">No classes available</p></div>';
                return;
            }

            // Filter classes by membership
            const membershipPlan = currentParent?.Membership_Plan || '';
            const availableClasses = currentClasses.filter(cls => {
                const allowed = (cls.Allowed_Memberships || '').toLowerCase();
                return allowed.includes(membershipPlan.toLowerCase());
            });

            let html = '';
            
            availableClasses.forEach(cls => {
                html += `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${cls.Name || 'Class'}</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">
                                    ${cls.Day} at ${cls.Time}
                                </p>
                                <p style="color: #6b7280; font-size: 13px;">
                                    ${cls.Description || 'No description available'}
                                </p>
                            </div>
                            <button class="btn-primary" onclick="attendClass('${cls.Class_Id}', '${cls.Name}')">
                                Attend This Class
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="card"><p style="text-align: center; color: #6b7280;">No classes available for your membership level</p></div>';
        }

        // Populate announcements
        function populateAnnouncements(announcements) {
            const container = document.getElementById('announcements-list');
            
            if (announcements.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #6b7280;">No announcements</p></div>';
                return;
            }

            let html = '';
            
            announcements.forEach(ann => {
                html += `
                    <div class="card">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${ann.Title}</h3>
                        <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">${ann.Date}</p>
                        <p style="color: #374151; font-size: 14px; line-height: 1.6;">${ann.Description}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Populate billing
        function populateBilling() {
            const container = document.getElementById('billing-info');
            
            const isPaid = currentParent?.Membership_Status === 'paid';
            const plan = currentParent?.Membership_Plan || 'N/A';
            const price = currentParent?.Membership_Price || 0;

            // Square payment links per plan
            const paymentLinks = {
                'Standard': 'https://square.link/u/STANDARD_LINK', // Replace with actual
                'Silver': 'https://square.link/u/SILVER_LINK',
                'Gold': 'https://square.link/u/GOLD_LINK'
            };

            const paymentUrl = paymentLinks[plan] || '#';

            const html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">${plan} Plan</h3>
                        <p style="color: #6b7280; font-size: 16px;">$${price}/month</p>
                    </div>
                    <span class="badge ${isPaid ? 'badge-paid' : 'badge-unpaid'}" style="font-size: 14px; padding: 8px 16px;">
                        ${isPaid ? 'Paid' : 'Unpaid'}
                    </span>
                </div>

                ${!isPaid ? `
                    <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border: 1px solid #fecaca; margin-bottom: 20px;">
                        <p style="font-size: 14px; color: #991b1b; margin-bottom: 12px; font-weight: 500;">
                            ‚ö†Ô∏è Payment Required - Complete your payment to activate full access
                        </p>
                        <a href="${paymentUrl}" target="_blank" style="text-decoration: none;">
                            <button class="btn-primary" style="width: 100%;">
                                Pay Now - $${price}/month
                            </button>
                        </a>
                    </div>
                ` : `
                    <div style="background: #d1fae5; padding: 16px; border-radius: 8px; border: 1px solid #a7f3d0; margin-bottom: 20px;">
                        <p style="font-size: 14px; color: #065f46; font-weight: 500;">
                            ‚úì Your membership is active
                        </p>
                    </div>
                `}

                <div style="margin-top: 24px;">
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Plan Details</h4>
                    <div style="padding: 16px; background: #f9fafb; border-radius: 8px;">
                        <p style="font-size: 14px; color: #374151; margin-bottom: 8px;">‚Ä¢ Membership: ${plan}</p>
                        <p style="font-size: 14px; color: #374151; margin-bottom: 8px;">‚Ä¢ Monthly Rate: $${price}</p>
                        <p style="font-size: 14px; color: #374151; margin-bottom: 8px;">‚Ä¢ Students: ${currentStudents.length}</p>
                        <p style="font-size: 14px; color: #374151;">‚Ä¢ Status: ${isPaid ? 'Active' : 'Payment Pending'}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Populate profile settings
        function populateProfile() {
            if (!currentParent) return;

            document.getElementById('profile-first-name').value = currentParent.First_Name || '';
            document.getElementById('profile-last-name').value = currentParent.Last_Name || '';
            document.getElementById('profile-phone').value = currentParent.Phone || '';
            document.getElementById('profile-emergency').value = currentParent.Emergency_Contact || '';
        }

        // Populate store
        function populateStore() {
            const container = document.getElementById('products-grid');
            
            let html = '';
            
            STORE_PRODUCTS.forEach(product => {
                html += `
                    <div class="product-card">
                        <img src="${product.image}" alt="${product.name}" class="product-image">
                        <div style="padding: 16px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${product.name}</h3>
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">${product.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 20px; font-weight: 700; color: #013378;">$${product.price}</span>
                                <a href="${product.checkoutUrl}" target="_blank" style="text-decoration: none;">
                                    <button class="btn-primary">Buy Now</button>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Attend class function
        function attendClass(classId, className) {
            // This would notify the owner that parent/student plans to attend
            // For now, just show confirmation
            alert(`Great! We've noted that you plan to attend ${className}. See you there!`);
            
            // In future: could update a "Class_Attendance_Plans" sheet
        }

        // Pay for belt test
        function payForBeltTest(studentId, nextBelt, price) {
            // Redirect to Square checkout for belt test
            // For now, using placeholder
            const beltTestUrl = `https://square.link/u/BELT_TEST_${nextBelt.replace(/\s+/g, '_')}`;
            
            if (confirm(`Pay $${price} for ${nextBelt} belt test?`)) {
                window.open(beltTestUrl, '_blank');
                
                // After payment, you'd update the student's belt rank via webhook
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Highlight nav item
            event.target.classList.add('active');
        }

        // Handle profile form submission
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get values
            const firstName = document.getElementById('profile-first-name').value;
            const lastName = document.getElementById('profile-last-name').value;
            const phone = document.getElementById('profile-phone').value;
            const emergency = document.getElementById('profile-emergency').value;

            // Update in Sheets via SheetDB
            try {
                const updateData = {
                    First_Name: firstName,
                    Last_Name: lastName,
                    Phone: phone,
                    Emergency_Contact: emergency
                };

                await fetch(`https://sheetdb.io/api/v1/7gridxho6ejta?sheet=Parents&Parent_Id=${currentParent.Parent_Id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: updateData })
                });

                alert('Profile updated successfully!');
                
                // Reload data
                await loadParentData(currentParent.Email);
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });

        // Logout
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
